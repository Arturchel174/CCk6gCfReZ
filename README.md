# StoryVault — Приложение доски сообщений на Yii2

StoryVault — это веб-приложение доски сообщений, созданное на фреймворке Yii2, где пользователи могут делиться сообщениями с возможностью прикрепления изображений.

## Возможности

### Основной функционал
- ✅ **Создание сообщений**: Пользователи могут создавать сообщения, указывая:
    - Имя автора (2-15 символов)
    - Действительный email-адрес
    - Текст сообщения (5-1000 символов, разрешены HTML-теги: `<b>`, `<i>`, `<s>`)
    - Опциональная загрузка изображения (JPG, PNG, WEBP, макс. 2МБ, макс. разрешение 1500px)
    - Проверка с помощью Captcha

- ✅ **Ограничение частоты запросов (Rate Limiting)**: Настраиваемое ограничение на создание сообщений (по умолчанию: 1 сообщение в 3 минуты)
    - По IP-адресу
    - По email-адресу
    - Комбинированное (IP + email)

- ✅ **Отображение сообщений**:
    - Макет на основе карточек Bootstrap
    - Поддержка пагинации
    - Относительные метки времени (например, "5 минут назад")
    - Маскированные IP-адреса (для сохранения конфиденциальности)
    - Счетчик сообщений с одного IP-адреса
    - Очистка HTML от вредоносного кода

- ✅ **Управление сообщениями**:
    - Редактирование сообщений в течение 12 часов (только текст и изображение)
    - Удаление сообщений в течение 14 дней (мягкое удаление)
    - Безопасный доступ на основе токенов через email

- ✅ **Email-уведомления**:
    - Ссылки для управления отправляются после создания сообщения
    - Режим отладки (email сохраняются в файлы)

## Технический стек

- **Фреймворк**: Yii2 Basic Template
- **PHP**: 8.3
- **База данных**: MySQL
- **Фронтенд**: Bootstrap 5
- **Контейнеризация**: Docker и Docker Compose

## Установка

### Предварительные требования
- Docker и Docker Compose
- Git

### Шаги установки

1.  **Клонируйте репозиторий**
    ```bash
    git clone <repository-url>
    cd CCk6gCfReZ
    ```

2.  **Запустите Docker-контейнеры**
    ```bash
    docker compose up --build -d
    ```

3.  **Установите зависимости**
    ```bash
    docker exec -it site_php sh
    cd site && composer install
    ```

4.  **Выполните миграции базы данных**
    ```bash
    php yii migrate
    ```

5.  **Откройте приложение**
    Откройте ваш браузер и перейдите по адресу: `http://localhost` (или другой настроенный хост)

## Конфигурация

Параметры конфигурации находятся в файле `/www/site/config/params.php`:

| Параметр | Тип | По умолчанию | Описание |
|---|---|---|---|
| `post_rate_limit_mode` | string | `'ip'` | Стратегия ограничения: `'ip'`, `'email'` или `'combined'` |
| `post_rate_limit_interval` | integer | `180` | Интервал между сообщениями в секундах (3 минуты) |
| `post_image_max_size` | integer | `2097152` | Макс. размер изображения в байтах (2МБ) |
| `post_image_max_dimension` | integer | `1500` | Макс. ширина/высота в пикселях |
| `post_edit_window` | integer | `43200` | Окно для редактирования в секундах (12 часов) |
| `post_delete_window` | integer | `1209600` | Окно для удаления в секундах (14 дней) |
| `upload_directory` | string | `'uploads/posts'` | Путь для хранения изображений относительно корневой веб-директории |

## Структура проекта

```
www/site/
├── assets/           # Ресурсы (Asset bundles)
├── commands/         # Консольные команды
├── components/       # Пользовательские компоненты
│   └── RateLimiter.php
├── config/           # Конфигурация приложения
│   ├── web.php       # Конфигурация веб-приложения
│   ├── params.php    # Параметры приложения
│   └── db.php        # Конфигурация базы данных
├── controllers/      # MVC Контроллеры
│   ├── PostController.php        # Создание и отображение сообщений
│   ├── ManagementController.php  # Редактирование/удаление сообщений
│   └── SiteController.php        # Контроллер страниц сайта
├── helpers/          # Вспомогательные классы
│   └── IpHelper.php  # Утилиты для маскировки IP
├── mail/             # Шаблоны email
│   └── post-created.php
├── messages/         # i18n переводы
│   └── ru/app.php
├── migrations/       # Миграции базы данных
│   └── m251111_172503_create_post_table.php
├── models/           # MVC Модели
│   ├── Post.php      # Сущность "Сообщение"
│   └── PostQuery.php # Запрос для сообщений с поддержкой мягкого удаления
├── views/            # MVC Представления
│   ├── layouts/
│   ├── post/
│   │   ├── index.php
│   │   └── _card.php
│   └── management/
│       ├── edit.php
│       └── delete.php
└── web/              # Корневая веб-директория
    ├── uploads/posts/  # Загруженные изображения
    └── index.php
```

## Объяснение ключевых возможностей

### Мягкое удаление (Soft Delete)
Сообщения никогда не удаляются из базы данных физически. Вместо этого устанавливается метка времени `deleted_at`, а класс `PostQuery` автоматически отфильтровывает "мягко удаленные" записи.

### Маскировка IP
Для конфиденциальности IP-адреса частично маскируются:
- **IPv4**: Последние 2 октета скрыты (например, `192.168.**.**`)
- **IPv6**: Последние 4 секции скрыты (например, `2001:0db8:11a3:09d7:****:****:****:****`)

### Безопасные токены
Для каждого сообщения генерируется криптографически стойкий 64-символьный токен, который используется для операций редактирования/удаления через ссылки в email.

### Ограничение частоты запросов (Rate Limiting)
Предотвращает спам, ограничивая частоту публикаций. Доступны три режима:
1.  **Режим IP**: Ограничение только по IP-адресу.
2.  **Режим Email**: Ограничение только по email-адресу.
3.  **Комбинированный режим**: Должны совпадать и IP, и email.

### Очистка HTML (HTML Sanitization)
Сообщения пользователей очищаются с помощью HtmlPurifier, чтобы разрешить только безопасные HTML-теги (`<b>`, `<i>`, `<s>`).

## Ссылки для управления в email

После создания сообщения пользователь получает email с:
- **Ссылкой для редактирования**: `http://yoursite.com/manage/edit/{token}`
- **Ссылкой для удаления**: `http://yoursite.com/manage/delete/{token}`

Срок действия этих ссылок истекает:
- Редактирование: через 12 часов после создания сообщения.
- Удаление: через 14 дней после создания сообщения.

## Функции безопасности

- ✅ Предотвращение SQL-инъекций (Active Record с привязкой параметров)
- ✅ Предотвращение XSS-атак (очистка HTML)
- ✅ CSRF-защита (включена для всех форм)
- ✅ Безопасность при загрузке файлов (проверка MIME-типа, ограничение размера, проверка расширений)
- ✅ Генерация безопасных токенов (криптографически стойкие случайные байты)
- ✅ Конфиденциальность email (адреса не отображаются публично)

## Команды Docker

```bash
# Запустить контейнеры
docker compose up -d

# Остановить контейнеры
docker compose down

# Просмотреть логи
docker compose logs -f

# Войти в PHP-контейнер
docker exec -it site_php sh

# Войти в MySQL-контейнер
docker exec -it site_mysql mysql -u root -p
```

## Разработка

### Выполнение миграций

```bash
# Создать новую миграцию
php yii migrate/create migration_name

# Применить миграции
php yii migrate

# Откатить последнюю миграцию
php yii migrate/down
```

### Режим отладки

В режиме разработки email сохраняются в директорию `/www/site/runtime/mail/`. Проверяйте эту папку, чтобы просмотреть отправленные письма.

---

**Создано с помощью Yii2 Framework**